openapi: 3.0.3
info:
  title: CLI Execution Control Contract
  version: 1.0.0
  description: >-
    Conceptual contract describing CLI execution behaviors for dry-run, diff,
    and apply. This is a documentation contract for deterministic execution.
servers:
  - url: https://localhost
paths:
  /runs:
    post:
      summary: Execute a run in dry-run, diff, or apply mode
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RunRequest'
      responses:
        '200':
          description: Successful execution
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunReport'
        '400':
          description: Invalid input or conflicting flags
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Validation failure (e.g., copy-value not confirmed)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Fatal execution error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
components:
  schemas:
    RunRequest:
      type: object
      required:
        - keyvaultUri
        - appconfigEndpoint
        - executionMode
      properties:
        keyvaultUri:
          type: string
        appconfigEndpoint:
          type: string
        executionMode:
          type: string
          enum: [dry-run, diff, apply]
        mode:
          type: string
          enum: [kvref, copyvalue]
          default: kvref
        confirmCopyValue:
          type: boolean
        environment:
          type: string
        mappingFile:
          type: string
        parallelism:
          type: integer
          minimum: 1
        includePrefix:
          type: string
        excludeRegex:
          type: string
        onlyTag:
          type: string
        reportJson:
          type: string
    RunReport:
      type: object
      properties:
        runId:
          type: string
        timestamp:
          type: string
        executionMode:
          type: string
        totals:
          type: object
          properties:
            scanned:
              type: integer
            changed:
              type: integer
            skipped:
              type: integer
            failed:
              type: integer
        changes:
          type: array
          items:
            $ref: '#/components/schemas/ChangeSummary'
        failures:
          type: array
          items:
            $ref: '#/components/schemas/FailureSummary'
    ChangeSummary:
      type: object
      properties:
        key:
          type: string
        label:
          type: string
        action:
          type: string
          enum: [create, update, noop, skip]
        reason:
          type: string
    FailureSummary:
      type: object
      properties:
        key:
          type: string
        errorType:
          type: string
        message:
          type: string
    ErrorResponse:
      type: object
      properties:
        code:
          type: string
        message:
          type: string
